import { BRANCHING_OUTLIER_SETS } from './branchingOutliers';

/**
 * SEASON ONE CASES
 *
 * Chapter 1 (001A-001C): Full static content - played before LLM generation begins
 * Chapters 2-12 (002A-012C): Minimal skeletons - content is dynamically generated by LLM
 *
 * The LLM generates: narrative, puzzles (board/outlierWords), briefing, evidenceBoard, themes
 * Only the case structure (id, caseNumber, day, season, attempts) is needed for navigation
 */

const RAW_SEASON_ONE_CASES = [
  // ============================================================================
  // CHAPTER 1: STATIC CONTENT (Pre-LLM, Full Content Required)
  // ============================================================================
  {
    id: 1,
    caseNumber: '001A',
    season: 1,
    day: 1,
    title: 'Midnight Delivery',
    mainTheme: { name: 'COMMUNICATION', icon: 'âœ‰ï¸' },
    outlierTheme: { name: 'BEGINNINGS', icon: 'ðŸ”“' },
    attempts: 4,
    dailyIntro: `Some confessions arrive at midnight. Some arrive seven years late. All of them cost something.`,
    briefing: {
      summary: 'A mysterious envelope appeared at your door. Scan the items on your desk to identify the four methods the Confessor is using to stalk you.',
      objectives: [
        'Scan your desk for the specific communication channels the Confessor weaponises.',
        'Isolate the four specific methods she used to deliver her ultimatum.',
        'Lock the grid to prove you can hear her signal.',
      ],
    },
    bridgeText: ["The first message always arrives when you're not looking. By the time you read it, the game has already begun."],
    evidenceBoard: {
      polaroids: [
        { id: '001A-confessor-arrival', imageKey: 'silence', title: 'MIDNIGHT VISITOR', subtitle: '2:47 AM ARRIVAL', detail: 'Perfumed stranger. No knock. Just the slide of paper under the door and the scent of expensive French perfume lingering like a ghost.' },
        { id: '001A-eleanor-call', imageKey: 'sparkle', title: "ELEANOR'S PLEA", subtitle: 'GREYSTONE EMERGENCY', detail: 'Sarah called at 3 AM. Eleanor Bellamy poisoned with ricin. She swore she was framed eight years ago. She swore there was a woman in red.' },
        { id: '001A-ultimatum-envelope', imageKey: 'default', title: 'BLACK ENVELOPE', subtitle: 'THE ULTIMATUM', detail: '"Twelve days. Twelve cases. One you closed without certainty." Heavy stock. Red wax seal. The game piece that started the clock.' },
      ],
    },
    board: {
      mainWords: ['LETTER', 'EMAIL', 'TEXT', 'CALL', 'VOICEMSG', 'MEMO', 'NOTE', 'FAX', 'CHAT', 'DISPATCH', 'TELEGRAM', 'MESSAGE'],
      outlierWords: ['ORIGIN', 'START', 'FIRST', 'DAWN'],
    },
    clueSummaries: {
      main: 'You found the BEGINNINGS. Now read the journal to see how Jack uses it.',
      outliers: {
        ORIGIN: 'Points Jack straight back to the Emily Cross file he buriedâ€”the origin she demands he reopen.',
        START: 'Marks the first square in her twelve-day gauntlet and the moment the game truly begins.',
        FIRST: 'Reminds him there was a first innocent he ignored, and that certainty cut someone loose.',
        DAWN: 'Foreshadows the daily unlocksâ€”he can rest, but the next reckoning arrives at dawn regardless.',
      },
    },
    narrative: [`{puzzle_callback}. I scanned the items on my desk. Letter. Note. Message. Dispatch. All methods of communication. All pointing to one thing: the game had begun.

Rain fell on Ashport the way memory falls on the guiltyâ€”relentless, cold, and impossible to outrun. My office sat four floors above street level, a corner box that smelled like yesterday's cigarettes and broken promises. Three hundred a month bought me water-stained walls and a view of Murphy's Bar, where neon script bled red through the windowâ€”GIRLS and DRINKS flickering like a dying heartbeat, painting everything in the color of old sins.

The clock said 2:47 AM. My body said older than that.

I needed sleep. What I had was Jameson in a coffee cup and the high-frequency whine of thirty years' worth of gunfire playing symphony in my skull. The bottle was half empty. Had been for three days. Same bottle. Same drunk. Same detective pretending retirement was a choice instead of a sentence.

Then I heard themâ€”footsteps on the stairs.

Wrong. All wrong. Not the stumbling percussion of Murphy's refugees looking for a place to piss. Not the heavy tread of cops who still thought I might know something useful. These steps were a metronome. Precise. Someone who'd memorized which boards creaked and how to avoid them.

My .38 Special was in the desk drawer, buried under case files I'd never finish and bills I couldn't pay. I had it in my hand before the shadow stopped outside my door. Old habits. The kind that keep you breathing when thinking would get you killed.

No knock. No introduction. Just the whisper of paper sliding under wood, intimate as a confession.

By the time I yanked the door open, the hallway was empty. Nothing but the ghost of perfumeâ€”something French and expensive, the kind that costs more than I made in a month back when I still made money.

The envelope lay on the threshold like a black tongue. Heavy paper. Red wax seal. My name in silver ink: *Detective Jack Halloway*.

Inside, elegant script:

**"Dearest Detective,**

**Twelve days. Twelve cases. Eleven you closed with absolute certainty. One you closed without it.**

**By the end, you'll understand what you took from me.**

**The game begins now.**

**â€”The Midnight Confessor"**

Twelve cases. Eleven with certainty. One without.

My phone lit up. Sarah Reeves. My former partner.

"Tell me you're not involved." No hello. No preamble.

"In what?"

"Eleanor Bellamy. Someone tried to poison her tonight at Greystone."

The name hit like a fist. Eleanor Bellamy. Eight years ago. Society widow I'd convicted of murdering her husband.

She'd sworn someone framed her. Kept talking about a woman in red. I'd marked it *"unreliableâ€”subject in denial."*

"What poison?" My voice came out rust and gravel.

"Ricin. Warden found a note under her dinner tray: *'The widow knows the truth. Ask her about the woman in red.'"*

"Jack, someone broke into Evidence Room C last night. Stole twelve case files. Your cases, Jack. Your biggest wins."

I looked at the black envelope again. *Twelve cases. Twelve days.*

I grabbed my coat. If Eleanor was innocent, I needed to hear it from her mouth.

And if I'd been wrong once, how many other times?

**[PUZZLE THEME: COMMUNICATION / OUTLIER: BEGINNINGS]**`],
    unknownMessage: '"Day One complete. You\'ve learned that evidence can be manufactured. That innocence can be bought and sold. That the woman in red was always thereâ€”you just refused to see her."',
  },
  {
    id: 2,
    caseNumber: '001B',
    season: 1,
    day: 1,
    title: "The Widow's Testimony",
    mainTheme: { name: 'COMMUNICATION', icon: 'âœ‰ï¸' },
    outlierTheme: { name: 'GEMSTONES', icon: 'ðŸ’Ž' },
    attempts: 4,
    dailyIntro: `PREVIOUSLY: Black envelope at 2:47 AM. Twelve cases. One closed without certainty. Sarah calledâ€”Eleanor Bellamy poisoned at Greystone. Evidence stolen. Twelve files, twelve days.`,
    briefing: {
      summary: "Eleanor claims she was framed. Profile her financial status. Isolate the four luxury items that don't fit a struggling widow's budget.",
      objectives: [
        "Review the case file for items that don't match Eleanor's financial profile.",
        'Identify the four expensive objects planted in her safety deposit box.',
        'Clear the board to expose the evidence that was manufactured.',
      ],
    },
    bridgeText: ['Prison keeps secrets better than confessionals. But some secrets are worth dying to tell.'],
    evidenceBoard: {
      polaroids: [
        { id: '001B-visitation-booth', imageKey: 'sparkle', title: 'GREYSTONE VISIT', subtitle: 'DYING DECLARATION', detail: 'Eleanor looked like charcoal sketches of her former self. Shackled. Coughing blood. "Mrs. died when you sent me here."' },
        { id: '001B-scarlet-visitor', imageKey: 'silence', title: 'SCARLET VISITOR', subtitle: 'PRISON LOG', detail: 'A woman in red visited three weeks ago. Told Eleanor that Jack Halloway would come. That he would finally learn what certainty costs.' },
        { id: '001B-ricin-note', imageKey: 'default', title: 'RICIN NOTE', subtitle: 'TRAY MESSAGE', detail: '"The widow knows the truth. Ask her about the woman in red." Found under her dinner tray.' },
      ],
    },
    board: {
      mainWords: ['CONFESSION', 'VISITATION', 'PRISON', 'SHACKLES', 'GUARD', 'LETTER', 'VOICE', 'WHISPER', 'TRUTH', 'PLEA', 'CAGE', 'WITNESS'],
      outlierWords: ['SAPPHIRE', 'NECKLACE', 'JEWEL', 'STONE'],
    },
    clueSummaries: {
      main: 'You found the GEMSTONES. Now read the journal to see how Jack uses it.',
      outliers: {
        SAPPHIRE: 'Shines a light on the planted necklace that sank the trial.',
        NECKLACE: "Names the forged heirloom that never appeared in Richard's catalog.",
        JEWEL: 'Signals the luxury bait Victoria used to manufacture certainty.',
        STONE: 'Reminds Jack that every glittering clue was a weapon placed in plain sight.',
      },
    },
    narrative: [`{puzzle_callback}. I looked at the list I'd just compiled. Sapphire. Necklace. Jewel. None of these fit Eleanor's life.

Greystone Correctional squatted on the edge of Ashport like a tombstone in a suit. Eleanor Bellamy looked like God had sketched her in charcoal and then smudged the edges. Eight years inside had carved away everything soft.

"Detective Halloway." Not a question. A confirmation. The way you'd identify a tumor.

"She said you'd come. Said you'd finally understand."

"Who?"

"The woman who visited three weeks ago. Elegant. Beautiful in that way that feels dangerous. She said, 'Tell him the woman in red sent her regards.'"

The woman in red. The phantom Eleanor had sworn existed. The one I'd marked as *fabrication* in my report.

"Tell me about the night your husband died."

"Why? You didn't believe me the first ten times." But she kept talking. "The woman in red came the night before Richard died. They were arguing. About money. About leverage. She said, 'You're either with me or you're evidence.' Two days later, Richard was dead."

"Why didn't you tell me?"

"I DID. I told you seventeen times. You wrote it in your report: *'Subject fixated on phantom woman in red. Classic deflection. Unreliable.'* You trusted tea sets more than people."

"The sapphire necklace," I said. "The two-hundred-thousand-dollar one. How do you explain that?"

"I can't. I never saw it before the trial. Richard cataloged every piece of jewelry I owned. That necklace wasn't in any catalog. Someone planted it."

Seven years. That timeline scratched at something in my memory.

My phone buzzed. Sarah: **"Someone broke into Bellamy estate tonight. Don't go. It's a trap."**

I turned the car toward the Bellamy estate. Into the trap. Into the rain.

Because the only thing worse than being wrong is never finding out.

**[OUTLIER THEME: GEMSTONES]**`],
    unknownMessage: '"Maya Bellamy is safe, Detective. She\'s with me. We\'re discussing her mother\'s innocence. Come to the Bellamy estate. See what truth looks like when you finally bother to look. â€”M.C."',
  },
  {
    id: 3,
    caseNumber: '001C',
    season: 1,
    day: 1,
    title: 'The Sapphire Trail',
    mainTheme: { name: 'COMMUNICATION', icon: 'âœ‰ï¸' },
    outlierTheme: { name: 'CHESS PIECES', icon: 'â™Ÿï¸' },
    attempts: 4,
    dailyIntro: `PREVIOUSLY: Eleanor in Greystone, dying from ricin. Eight years for maybe. She told him about the woman in redâ€”elegant, dangerous, building evidence. Maya called, terrified. Then silence. Victoria had her.`,
    briefing: {
      summary: 'The Confessor left a calling card on the desk. Decode the specific game pieces she is using to describe your team.',
      objectives: [
        'Analyze the chess board left by the Confessor.',
        'Identify the four pieces representing the players in this game.',
        'Decipher the metaphor to understand the threat.',
      ],
    },
    bridgeText: ['Sometimes evidence tells the truth. Sometimes it tells the story someone needed you to believe.'],
    evidenceBoard: {
      polaroids: [
        { id: '001C-ruined-study', imageKey: 'default', title: 'BELLAMY STUDY', subtitle: 'CRACKED SAFE', detail: "Richard's study. The safe was empty. The jewelry catalog was missing. Proof that the sapphire necklace was never recorded." },
        { id: '001C-day-one-pawn', imageKey: 'silence', title: 'OBSIDIAN PAWN', subtitle: 'GAME PIECE', detail: '"DAY ONE: THE INNOCENT SUFFER." A heavy stone token marking the first casualty of the Confessor\'s lesson.' },
        { id: '001C-sarah-sweep', imageKey: 'voice', title: 'SARAH REEVES', subtitle: 'PARTNER SWEEP', detail: 'Sarah beat me to the scene. Found the break-in. Warned me that seven years ago, Emily Cross disappeared.' },
      ],
    },
    board: {
      mainWords: ['STUDY', 'LEDGER', 'SAFE', 'CATALOG', 'DOOR', 'FOOTSTEP', 'FLASHLIGHT', 'FILE', 'PHOTO', 'PAWN', 'LETTER', 'EVIDENCE'],
      outlierWords: ['PAWN', 'KNIGHT', 'BISHOP', 'CHECK'],
    },
    clueSummaries: {
      main: 'You found the CHESS PIECES. Now read the journal to see how Jack uses it.',
      outliers: {
        PAWN: 'Marks the first chess piece Victoria uses to grade his progress.',
        KNIGHT: 'Hints at the unseen moves already positioned against Jack.',
        BISHOP: 'Signals the diagonal strikesâ€”evidence that cuts across his assumptions.',
        CHECK: 'Warns that the Confessor is measuring how close she is to cornering him.',
      },
    },
    narrative: [`I analyzed the outliers. {puzzle_callback}. The pieces were on the board.

The Bellamy estate sat on three acres of manicured despair. Eight years of abandonment had turned elegance into rot. The front door was open. An invitation or a trap. In my experience, they were usually the same thing.

Sarah Reeves sat in Richard's leather chair. "Jesus Christ, Jack. You trying to give me a heart attack?"

"What the hell are you doing here?"

"My job." She moved to the wall behind the desk. The safe. Door open. Empty. "Someone opened this tonight. Professional job. Took everything."

"Richard's jewelry catalog," I said. "Eleanor told me. That sapphire necklace was never in the catalog. Someone planted it."

On the desk: a black chess piece. A pawn. Obsidian. Carved into the base: **"DAY ONE: THE INNOCENT SUFFER."**

My phone buzzed. Text from unknown number:

**"Day One complete, Detective. You've learned that evidence can be manufactured. That the woman in red was real. She was always there. You just refused to see her.**

**Tomorrow brings a businessman's fall. A partner's betrayal that cuts deeper than you can imagine.**

**â€”The Midnight Confessor"**

Day One was over. I'd learned that Eleanor Bellamy might be innocent. That the woman in red was real. That someone had spent seven years planning my destruction.

Eleven days to go. Twelve cases to revisit.

The game had just begun.

**[OUTLIER THEME: CHESS PIECES]**`],
    unknownMessage: '"Day One complete. You\'ve learned that evidence can be manufactured. That the woman in red was always thereâ€”you just refused to see her."',
  },

  // ============================================================================
  // CHAPTERS 2-12: MINIMAL SKELETONS (Content generated dynamically by LLM)
  // ============================================================================
  // Chapter 2
  { id: 4, caseNumber: '002A', season: 1, day: 2, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 5, caseNumber: '002B', season: 1, day: 2, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 6, caseNumber: '002C', season: 1, day: 2, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 3
  { id: 7, caseNumber: '003A', season: 1, day: 3, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 8, caseNumber: '003B', season: 1, day: 3, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 9, caseNumber: '003C', season: 1, day: 3, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 4
  { id: 10, caseNumber: '004A', season: 1, day: 4, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 11, caseNumber: '004B', season: 1, day: 4, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 12, caseNumber: '004C', season: 1, day: 4, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 5
  { id: 13, caseNumber: '005A', season: 1, day: 5, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 14, caseNumber: '005B', season: 1, day: 5, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 15, caseNumber: '005C', season: 1, day: 5, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 6
  { id: 16, caseNumber: '006A', season: 1, day: 6, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 17, caseNumber: '006B', season: 1, day: 6, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 18, caseNumber: '006C', season: 1, day: 6, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 7
  { id: 19, caseNumber: '007A', season: 1, day: 7, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 20, caseNumber: '007B', season: 1, day: 7, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 21, caseNumber: '007C', season: 1, day: 7, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 8
  { id: 22, caseNumber: '008A', season: 1, day: 8, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 23, caseNumber: '008B', season: 1, day: 8, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 24, caseNumber: '008C', season: 1, day: 8, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 9
  { id: 25, caseNumber: '009A', season: 1, day: 9, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 26, caseNumber: '009B', season: 1, day: 9, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 27, caseNumber: '009C', season: 1, day: 9, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 10
  { id: 28, caseNumber: '010A', season: 1, day: 10, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 29, caseNumber: '010B', season: 1, day: 10, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 30, caseNumber: '010C', season: 1, day: 10, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 11
  { id: 31, caseNumber: '011A', season: 1, day: 11, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 32, caseNumber: '011B', season: 1, day: 11, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 33, caseNumber: '011C', season: 1, day: 11, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  // Chapter 12
  { id: 34, caseNumber: '012A', season: 1, day: 12, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 35, caseNumber: '012B', season: 1, day: 12, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
  { id: 36, caseNumber: '012C', season: 1, day: 12, attempts: 4, title: 'Generated', mainTheme: { name: 'INVESTIGATION', icon: 'ðŸ”' }, outlierTheme: { name: 'GENERATED', icon: 'âš¡' } },
];

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const mergeBranchingMeta = (caseData) => {
  const meta = BRANCHING_OUTLIER_SETS[caseData.caseNumber];
  if (!meta) return caseData;

  const branchingSets = meta.sets || [];
  const allWords = branchingSets.flatMap((set) => set.words || []);
  const dedupedWords = [...new Set(allWords.map((w) => String(w).toUpperCase()))].filter((w) => w && w.length > 0);

  const board = caseData.board || {};
  const branchingSetsForBoard = branchingSets.length ? branchingSets.map(({ descriptions, ...rest }) => rest) : [];

  const updatedBoard = branchingSets.length > 0
    ? { ...board, outlierWords: dedupedWords.length ? dedupedWords : board.outlierWords, branchingOutlierSets: branchingSetsForBoard }
    : board;

  let clueSummaries = caseData.clueSummaries || null;
  if (branchingSets.length > 0) {
    const outlierWordSet = new Set(dedupedWords.map((word) => String(word).toUpperCase()));
    const filteredOutliers = {};
    const baseOutliers = caseData.clueSummaries?.outliers || {};
    Object.entries(baseOutliers).forEach(([word, detail]) => {
      if (word && detail && outlierWordSet.has(String(word).toUpperCase())) {
        filteredOutliers[word] = detail;
      }
    });
    branchingSets.forEach((set) => {
      Object.entries(set.descriptions || {}).forEach(([word, detail]) => {
        if (word && detail && outlierWordSet.has(String(word).toUpperCase())) {
          filteredOutliers[word] = detail;
        }
      });
    });
    clueSummaries = { ...(caseData.clueSummaries || {}), outliers: filteredOutliers };
  }

  const branchingThemeMeta = branchingSets
    .map((set) => set.theme ? { key: set.optionKey || set.key, optionKey: set.optionKey || set.key, name: set.theme.name, icon: set.theme.icon, summary: set.theme.summary } : null)
    .filter(Boolean);

  return {
    ...caseData,
    attempts: meta.attempts ?? caseData.attempts,
    board: updatedBoard,
    clueSummaries: clueSummaries || caseData.clueSummaries,
    branchingOutlierThemes: branchingThemeMeta.length ? branchingThemeMeta : caseData.branchingOutlierThemes || null,
  };
};

export const SEASON_ONE_CASES = RAW_SEASON_ONE_CASES.map(mergeBranchingMeta);
export const SEASON_ONE_CASE_COUNT = SEASON_ONE_CASES.length;
